{% extends 'mapBase.html' %}
{% load static %}
{% block content %}
<title>Map</title>
<script>
    function initMap() {
    let autocomplete;
    let placesService;
    let directionsService;
    let directionsRenderer;
    let originLocation;
    let openInfoWindow = null;
    let currentMarkers = [];
    let map;
    const MIN_ZOOM = 12; // Set the minimum zoom level

    var mapOptions = {
        center: { lat: 38.0336, lng: -78.5080 },
        zoom: 15,
        minZoom: MIN_ZOOM, // Set the minimum zoom level for the map
        styles: [
            {
                featureType: 'poi',
                stylers: [
                    { visibility: 'off' }
                ]
            }
        ]
    };

    map = new google.maps.Map(document.getElementById('map'), mapOptions);

    var input = document.getElementById('search-input');
    if (!input) {
        console.error('Search input not found.');
        return;
    }

    autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo('bounds', map);

    placesService = new google.maps.places.PlacesService(map);

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(map);

    autocomplete.addListener('place_changed', function () {
        var place = autocomplete.getPlace();
        if (!place.geometry) {
            window.alert("No details available for input: '" + place.name + "'");
            return;
        }

        originLocation = place.geometry.location;
        searchNearbyPlaces();
    });

    document.getElementById('radius-input').addEventListener('change', function() {
        if (originLocation) {
            searchNearbyPlaces();
        }
    });

    function searchNearbyPlaces() {
        currentMarkers.forEach(marker => marker.setMap(null));
        currentMarkers = [];

        var radiusValue = parseInt(document.getElementById('radius-input').value);

        var request = {
            location: originLocation,
            radius: radiusValue * 1000 || 5000, // Convert km to meters
            type: ['grocery_or_supermarket']
        };

        placesService.nearbySearch(request, function (results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                results.forEach(function (result) {
                    var marker = new google.maps.Marker({
                        position: result.geometry.location,
                        map: map,
                        title: result.name
                    });

                    currentMarkers.push(marker);

                    marker.addListener('click', function () {
                        if (openInfoWindow) {
                            openInfoWindow.close();
                        }

                        calculateAndDisplayRoute(originLocation, result.geometry.location);

                        var infoWindow = new google.maps.InfoWindow({
                            content: `<h3>${result.name}</h3><p>${result.vicinity}</p>`
                        });

                        infoWindow.open(map, marker);
                        openInfoWindow = infoWindow;
                    });
                });

                // Adjust map bounds to fit all markers
                var bounds = new google.maps.LatLngBounds();
                currentMarkers.forEach(marker => bounds.extend(marker.getPosition()));
                map.fitBounds(bounds);

                // Add a listener for when the zoom changes
                google.maps.event.addListenerOnce(map, 'zoom_changed', function() {
                    if (map.getZoom() > MIN_ZOOM) {
                        map.setZoom(MIN_ZOOM);
                    }
                });
            }
        });
    }

    function calculateAndDisplayRoute(origin, destination) {
        var selectedMode = document.getElementById('mode').value;

        directionsService.route({
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode[selectedMode.toUpperCase()]
        }, function (response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(response);

                var route = response.routes[0].legs[0];
                var distance = route.distance.text;
                var duration = route.duration.text;

                document.getElementById('route-info').innerHTML =
                    `${selectedMode.charAt(0).toUpperCase() + selectedMode.slice(1).toLowerCase()} Distance: ${distance}, Duration: ${duration}`;
            } else {
                window.alert('Directions request failed due to ' + status);
            }
        });
    }
}
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABHMSzBkIlURtKlubDpx6QDLzfmBtmYbE&callback=initMap&libraries=places">
</script>

<style>
    /* Ensure the content starts below the navbar */
    .search-container {
        margin-top: 70px; /* Adjust this depending on the height of your navbar */
        text-align: center;
        padding: 20px;
        background-color: #f8f9fa; /* Optional: light background for contrast */
    }

    #search-input {
        width: 500px;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #mode {
        margin-left: 10px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #map {
        height: 60%;  /* Fixed height, adjust as necessary */
        width: 100%;  /* Width as a percentage of the container */
        margin: 0 auto; /* Center the map horizontally */
    }

    /* Media query for responsiveness */
    @media (max-width: 768px) {
        #map {
            width: 100%;  /* On smaller screens, make the map full width */
            height: 300px; /* Smaller height for smaller screens */
        }
    }

    @media (max-width: 480px) {
        #map {
            height: 250px; /* Even smaller height for very small screens */
        }
    }

    #radius-input {
        width: 150px;
        padding: 8px;
        margin-left: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

</style>

<!-- Add the search bar in a container between the navbar and the map -->
<div class="search-container">
    <center>
        <input id="search-input" type="text" placeholder="Enter your start location">
        <select id="mode">
            <option value="DRIVING">Driving</option>
            <option value="WALKING">Walking</option>
            <option value="BICYCLING">Bicycling</option>
        </select>
        <input id="radius-input" type="number" placeholder="Enter radius in miles" style="margin-left: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </center>
</div>

<div id="route-info" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>

<div class="mapholder">
    <div id="map"></div>
</div>

{% endblock %}
