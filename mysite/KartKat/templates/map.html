{% extends 'mapBase.html' %}
{% load static %}
{% block content %}
<title>Map</title>

<html class="whatever" data-shoppingList = "{{ shopping_list }}"></html>
<html class="whatever" data-storesAndProducts = "{{ stores_and_products }}"></html>

<script>

    function initMap() {
    let autocomplete;
    let placesService;
    let directionsService;
    let directionsRenderer;
    let originLocation;
    let openInfoWindow = null;
    let currentMarkers = [];
    let map;
    const MIN_ZOOM = 12;
    let currentLocations = []; // Store the current list of locations

    var mapOptions = {
        center: { lat: 38.0336, lng: -78.5080 },
        zoom: 15,
        minZoom: MIN_ZOOM,
        styles: [
            {
                featureType: 'poi',
                stylers: [
                    { visibility: 'off' }
                ]
            }
        ]
    };

    map = new google.maps.Map(document.getElementById('map'), mapOptions);

    var input = document.getElementById('search-input');
    if (!input) {
        console.error('Search input not found.');
        return;
    }

    autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo('bounds', map);

    placesService = new google.maps.places.PlacesService(map);

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(map);

    autocomplete.addListener('place_changed', function () {
        var place = autocomplete.getPlace();
        if (!place.geometry) {
            window.alert("No details available for input: '" + place.name + "'");
            return;
        }

        originLocation = place.geometry.location;
        searchNearbyPlaces();
    });

    document.getElementById('radius-input').addEventListener('change', function() {
        if (originLocation) {
            searchNearbyPlaces();
        }
    });

    // Add event listener for the sort select
    document.getElementById('sort-select').addEventListener('change', function() {
        sortAndDisplayLocations();
    });

    // Add event listener for the mode select
    document.getElementById('mode').addEventListener('change', function() {
        if (originLocation) {
            searchNearbyPlaces(); // Update nearby grocery stores based on the selected mode
        }
    });

    function searchNearbyPlaces() {
        currentMarkers.forEach(marker => marker.setMap(null));
        currentMarkers = [];

        var radiusValue = parseInt(document.getElementById('radius-input').value);

        var request = {
            location: originLocation,
            radius: radiusValue * 1609.34, // Convert miles to meters
            type: ['grocery_or_supermarket']
        };

        placesService.nearbySearch(request, function (results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                let locationsWithRoutes = [];
                let processedCount = 0;

                results.forEach(function (result, index) {
                    calculateRoute(originLocation, result.geometry.location, function(routeInfo) {
                        if (routeInfo && routeInfo.distanceValue <= radiusValue * 1609.34) {
                            var marker = new google.maps.Marker({
                                position: result.geometry.location,
                                map: map,
                                title: result.name
                            });

                            currentMarkers.push(marker);

                            marker.addListener('click', function () {
                                if (openInfoWindow) {
                                    openInfoWindow.close();
                                }

                                calculateAndDisplayRoute(originLocation, result.geometry.location);

                                var infoWindow = new google.maps.InfoWindow({
                                    content: `<h3>${result.name}</h3><p>${result.vicinity}</p>`
                                });

                                infoWindow.open(map, marker);
                                openInfoWindow = infoWindow;
                            });

                            locationsWithRoutes.push({
                                ...result,
                                routeInfo: routeInfo
                            });
                        }

                        processedCount++;
                        if (processedCount === results.length) {
                            // All routes have been calculated
                            currentLocations = locationsWithRoutes;
                            sortAndDisplayLocations();

                            if (currentMarkers.length > 0) {
                                // Adjust map bounds to fit all markers
                                var bounds = new google.maps.LatLngBounds();
                                currentMarkers.forEach(marker => bounds.extend(marker.getPosition()));
                                map.fitBounds(bounds);

                                // Add a listener for when the zoom changes
                                google.maps.event.addListenerOnce(map, 'zoom_changed', function() {
                                    if (map.getZoom() > MIN_ZOOM) {
                                        map.setZoom(MIN_ZOOM);
                                    }
                                });
                            } else {
                                map.setCenter(originLocation);
                                map.setZoom(MIN_ZOOM);
                            }
                        }
                    });
                });
            }
        });
    }

    function calculateRoute(origin, destination, callback) {
        var selectedMode = document.getElementById('mode').value;

        directionsService.route({
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode[selectedMode.toUpperCase()]
        }, function (response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                var route = response.routes[0].legs[0];
                callback({
                    distance: route.distance.text,
                    duration: route.duration.text,
                    distanceValue: route.distance.value,
                    durationValue: route.duration.value
                });
            } else {
                callback(null);
                console.error('Directions request failed due to ' + status);
            }
        });
    }

    function calculateAndDisplayRoute(origin, destination) {
        var selectedMode = document.getElementById('mode').value;

        directionsService.route({
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode[selectedMode.toUpperCase()]
        }, function (response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(response);

                var route = response.routes[0].legs[0];
                var distance = route.distance.text;
                var duration = route.duration.text;

                document.getElementById('route-info').innerHTML =
                    `${selectedMode.charAt(0).toUpperCase() + selectedMode.slice(1).toLowerCase()} Distance: ${distance}, Duration: ${duration}`;
            } else {
                window.alert('Directions request failed due to ' + status);
            }
        });
    }

    function sortAndDisplayLocations() {
            const sortBy = document.getElementById('sort-select').value;

            let sortedLocations = [...currentLocations];

            if (sortBy === 'distance') {
                sortedLocations.sort((a, b) => a.routeInfo.distanceValue - b.routeInfo.distanceValue);
            } else if (sortBy === 'duration') {
                sortedLocations.sort((a, b) => a.routeInfo.durationValue - b.routeInfo.durationValue);
            } else if (sortBy === 'price') {
                sortedLocations.sort((a, b) => {
                    const priceA = getPriceForLocation(a);
                    const priceB = getPriceForLocation(b);
                    return priceA - priceB;
                });
                console.log(sortedLocations)
            }
            displayLocationList(sortedLocations);
    }

    function getPriceForLocation(location) {
        let totalPrice = 0;
        // const locationListElement = document.getElementById('location-list');
        // const sortSelectElement = document.getElementById('sort-select');
        const htmlElement = document.documentElement;
        let shoppingList = htmlElement.getAttribute('data-shoppingList');
        shoppingList = shoppingList.replace(/'/g, '"');
        const jsonShoppingList = JSON.parse(shoppingList);
        let storesAndProducts = htmlElement.getAttribute('data-storesAndProducts');
        storesAndProducts = storesAndProducts.replace(/(?<!\w)'(.*?)'(?!\w)/g, '"$1"');
        storesAndProducts = storesAndProducts.replace(/Decimal\("([^"]+)"\)/g, '"$1"');
        const jsonStoresAndProducts = JSON.parse(storesAndProducts);
        let locationItems = jsonStoresAndProducts[location.name];
        if (typeof locationItems === 'object' && locationItems !== null) {
            console.log("Made it in here")
            jsonShoppingList["Fruits"].forEach((item, index) => {
                const closestMatch = Object.keys(locationItems).find(locationItem =>
                        locationItem.toLowerCase().includes(item.toLowerCase())
                );
                console.log(item)
                // If a closest match is found, add its price to totalPrice
                if (closestMatch) {
                    totalPrice += parseFloat(locationItems[closestMatch]);
                }
            });
        }
        return totalPrice > 0 ? totalPrice : Infinity; // Treat locations with no matching items as the lowest price
    }

    function displayLocationList(locations) {
            const locationListElement = document.getElementById('location-list');
            const sortSelectElement = document.getElementById('sort-select');

            const htmlElement = document.documentElement;
            // Access the data-variableName attribute
            let shoppingList = htmlElement.getAttribute('data-shoppingList');
            shoppingList = shoppingList.replace(/'/g, '"');
            const jsonShoppingList = JSON.parse(shoppingList);
            let storesAndProducts = htmlElement.getAttribute('data-storesAndProducts');
            storesAndProducts = storesAndProducts.replace(/(?<!\w)'(.*?)'(?!\w)/g, '"$1"');
            storesAndProducts = storesAndProducts.replace(/Decimal\("([^"]+)"\)/g, '"$1"');
            const jsonStoresAndProducts = JSON.parse(storesAndProducts);

            if (locations.length > 0) {
                locationListElement.innerHTML = '<h2>Nearby Grocery Stores:</h2>';
                const ul = document.createElement('ul');
                locations.forEach((location, index) => {
                    let totalPrice = 0;
                    let locationItems = jsonStoresAndProducts[location.name];
                    if (typeof locationItems === 'object' && locationItems !== null) {
                        jsonShoppingList["Fruits"].forEach((item, index) => {
                            const closestMatch = Object.keys(locationItems).find(locationItem =>
                                locationItem.toLowerCase().includes(item.toLowerCase())
                            );

                            // If a closest match is found, add its price to totalPrice
                            if (closestMatch) {
                                totalPrice += parseFloat(locationItems[closestMatch]);
                            }
                        });
                    }

                    const li = document.createElement('li');
                    const routeInfo = location.routeInfo ?
                        `<br>Distance: ${location.routeInfo.distance}, Travel Time: ${location.routeInfo.duration}, Price: ${totalPrice > 0 ? `$${totalPrice.toFixed(2)}` : 'N/A - Does not sell items from your shopping list'}` :
                        '<br>Route information not available';
                    li.innerHTML = `<strong>${index + 1}. ${location.name}</strong> - ${location.vicinity}${routeInfo}`;
                    ul.appendChild(li);
                });
                locationListElement.appendChild(ul);

                // Show the sort select when there are locations
                sortSelectElement.style.display = 'inline-block';
            } else {
                locationListElement.innerHTML = '<p>No nearby grocery stores found.</p>';

                // Hide the sort select when there are no locations
                sortSelectElement.style.display = 'none';
            }
        }

}

</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABHMSzBkIlURtKlubDpx6QDLzfmBtmYbE&callback=initMap&libraries=places">
</script>

<style>
    /* Ensure the content starts below the navbar */
    .search-container {
        margin-top: 70px; /* Adjust this depending on the height of your navbar */
        text-align: center;
        padding: 20px;
        background-color: #f8f9fa; /* Optional: light background for contrast */
    }

    #search-input {
        width: 500px;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #mode {
        margin-left: 10px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #map {
        height: 60%;  /* Fixed height, adjust as necessary */
        width: 100%;  /* Width as a percentage of the container */
        margin: 0 auto; /* Center the map horizontally */
    }

    /* Media query for responsiveness */
    @media (max-width: 768px) {
        #map {
            width: 100%;  /* On smaller screens, make the map full width */
            height: 300px; /* Smaller height for smaller screens */
        }
    }

    @media (max-width: 480px) {
        #map {
            height: 250px; /* Even smaller height for very small screens */
        }
    }

    #radius-input {
        width: 150px;
        padding: 8px;
        margin-left: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

</style>

<!-- Add the search bar in a container between the navbar and the map -->
<div class="search-container">
    <center>
        <input id="search-input" type="text" placeholder="Enter your start location">
        <select id="mode">
            <option value="DRIVING">Driving</option>
            <option value="WALKING">Walking</option>
            <option value="BICYCLING">Bicycling</option>
        </select>
        <input id="radius-input" type="number" placeholder="Enter radius in miles" style="margin-left: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </center>
</div>

<div id="route-info" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>

<div class="mapholder">
    <div id="map"></div>
</div>

<select id="sort-select" style="margin-left: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; display: none;">
    <option value="none">Sort by...</option>
    <option value="distance">Distance</option>
    <option value="duration">Travel Time</option>
    <option value="price">Price</option>
</select>

<div id="location-list" style="margin-top: 20px; padding: 20px;">
    <!-- The list of locations will be inserted here -->
</div>

{% endblock %}